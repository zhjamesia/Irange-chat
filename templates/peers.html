<!DOCTYPE html>
<html>
<head>
    <title>PeerJS Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- <script src="./static/peerjs.min.js"></script> -->
</head>
<body>
    <h1>PeerJS Chat</h1>
    <input type="text" id="roomId" placeholder="Enter Room ID">
    <button id="joinRoom">Join Room</button>
    <button id="getPeers">Get Peers</button>
    <br><br>
    <select id="userSelect">
        <option value="">Select a user to chat with</option>
    </select>
    <br><br>
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button id="sendMessage">Send</button>
    <input type="file" id="imageInput" accept="image/*">
    <button id="sendImage">Send Image</button>
    <button id="takePicture">Take Picture</button>
    <!-- changed: add playsinline and mute local preview so iOS allows autoplay -->
    <video id="localVideo" autoplay playsinline muted></video>
    <!-- added: camera selector so user can pick which camera to use -->
    <select id="cameraSelect"><option value="">Default camera</option></select>
    <canvas id="canvas" style="display:none;"></canvas>
    <br><br>
    <button id="makeCall">Call Selected User</button>
    <!-- added: button to answer incoming calls (hidden until a call arrives) -->
    <button id="answerCall" style="display:none;">Answer Call</button>
    <br><br>
    <video id="remoteVideo" autoplay playsinline></video>
    <script>
        var peer;
        var roomId;
        var users = {};
        var conn;
        var localStream;
        var remoteVideo = document.getElementById('remoteVideo');
        var localVideo = document.getElementById('localVideo');
        // added cameraSelect reference
        var cameraSelect = document.getElementById('cameraSelect');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');

        // --- Changed: create peer with modern iceServers ("urls") and debug/error logging ---
        peer = new Peer({
            secure: true,
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        peer.on('error', function(err) {
            console.error('Peer error:', err);
        });

        // Helper: get or create a DataConnection and reuse it (important for iOS/Safari)
        function getOrCreateConnection(userId, cb) {
            if (!userId) return;
            // reuse existing open connection
            if (users[userId] && users[userId].conn && users[userId].conn.open) {
                return cb(users[userId].conn);
            }
            // create a new connection with reliable flag (helps Safari)
            var c = peer.connect(userId, { reliable: true });
            users[userId] = users[userId] || { id: userId };
            users[userId].conn = c;

            c.on('open', function() {
                console.log('Connection open to', userId);
                cb(c);
            });

            c.on('data', function(data) {
                // ensure inbound messages on outgoing connections are also handled
                var chatLog = document.getElementById('chatLog');
                if (typeof data === 'string') {
                    if (data.indexOf('data:image/') === 0) {
                        var image = document.createElement('img');
                        image.src = data;
                        image.style.maxWidth = '400px';
                        image.style.display = 'block';
                        chatLog.appendChild(image);
                        chatLog.innerHTML += '<br>';
                    } else {
                        chatLog.innerHTML += 'Peer: ' + data + '<br>';
                    }
                } else if (data instanceof Blob || data instanceof ArrayBuffer) {
                    var url = URL.createObjectURL(data);
                    var image = document.createElement('img');
                    image.src = url;
                    image.style.maxWidth = '400px';
                    image.style.display = 'block';
                    chatLog.appendChild(image);
                    chatLog.innerHTML += '<br>';
                } else {
                    try {
                        chatLog.innerHTML += 'Peer: ' + JSON.stringify(data) + '<br>';
                    } catch (e) {
                        chatLog.innerHTML += 'Peer sent data<br>';
                    }
                }
            });

            c.on('error', function(err) {
                console.error('Connection error with', userId, err);
            });

            c.on('close', function() {
                console.log('Connection closed to', userId);
                if (users[userId]) delete users[userId].conn;
            });
        }

        peer.on('open', function(id) {
            console.log('My peer ID is: ' + id);
            users[id] = users[id] || { id: id };
            var userSelect = document.getElementById('userSelect');
            var option = document.createElement('option');
            option.value = id;
            option.text = id;
            userSelect.add(option);
            document.getElementById('myPeerId').innerHTML = 'My Peer ID: ' + id;
        });

        document.getElementById('joinRoom').addEventListener('click', function() {
            roomId = document.getElementById('roomId').value;
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/join', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send('roomId=' + roomId + '&peerId=' + peer.id);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    console.log(xhr.responseText);
                }
            };
        });

        document.getElementById('getPeers').addEventListener('click', function() {
            roomId = document.getElementById('roomId').value;
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/get_peers', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send('roomId=' + roomId);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var peers = JSON.parse(xhr.responseText).peers;
                    var userSelect = document.getElementById('userSelect');
                    userSelect.innerHTML = '<option value="">Select a user to chat with</option>';
                    peers.forEach(function(peerId) {
                        if (peerId !== peer.id) {
                            var option = document.createElement('option');
                            option.value = peerId;
                            option.text = peerId;
                            userSelect.add(option);
                        }
                    });
                }
            };
        });

        document.getElementById('sendMessage').addEventListener('click', function() {
            var userId = document.getElementById('userSelect').value;
            var message = document.getElementById('messageInput').value;
            if (userId && message) {
                getOrCreateConnection(userId, function(conn) {
                    conn.send(message);
                    document.getElementById('chatLog').innerHTML += 'You: ' + message + '<br>';
                    document.getElementById('messageInput').value = '';
                });
            }
        });

        document.getElementById('sendImage').addEventListener('click', function() {
            var userId = document.getElementById('userSelect').value;
            var imageInput = document.getElementById('imageInput');
            if (userId && imageInput.files.length > 0) {
                var file = imageInput.files[0];
                var reader = new FileReader();
                reader.onload = function() {
                    var imageData = reader.result;
                    getOrCreateConnection(userId, function(conn) {
                        conn.send(imageData);
                        document.getElementById('chatLog').innerHTML += 'You sent an image<br>';
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('takePicture').addEventListener('click', function() {
            // ensure preview stream exists from selected camera
            ensureLocalStream(function(stream) {
                if (!stream) return;
                localVideo.srcObject = stream;
                localVideo.play().catch(function(){});
                // draw current frame to canvas after a short delay to allow frame to appear
                setTimeout(function(){
                    canvas.width = localVideo.videoWidth || 640;
                    canvas.height = localVideo.videoHeight || 480;
                    context.drawImage(localVideo, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(function(blob) {
                        var userId = document.getElementById('userSelect').value;
                        var reader = new FileReader();
                        reader.onload = function() {
                            var imageData = reader.result;
                            getOrCreateConnection(userId, function(conn) {
                                conn.send(imageData);
                                document.getElementById('chatLog').innerHTML += 'You sent an image<br>';
                            });
                        };
                        reader.readAsDataURL(blob);
                    }, 'image/png');
                }, 200);
            });
        });

        // New helper: request local media on demand (use user gesture)
        function ensureLocalStream(cb) {
            if (localStream) {
                // if a camera is selected that differs from current stream, recreate
                var selectedId = cameraSelect.value || null;
                var currentDeviceId = null;
                try {
                    var tracks = localStream.getVideoTracks();
                    if (tracks && tracks.length) {
                        // many browsers provide getSettings().deviceId
                        currentDeviceId = tracks[0].getSettings ? tracks[0].getSettings().deviceId : null;
                    }
                } catch (e) { currentDeviceId = null; }

                if (selectedId && currentDeviceId !== selectedId) {
                    // stop old tracks and fall through to request new stream
                    localStream.getTracks().forEach(function(t){ try{ t.stop(); }catch(e){} });
                    localStream = null;
                } else {
                    if (cb) cb(localStream);
                    // try to populate list now that permission granted
                    populateCameraList();
                    return;
                }
            }

            var selectedDeviceId = cameraSelect.value || null;
            var videoConstraints = selectedDeviceId ? { deviceId: { exact: selectedDeviceId } } : { facingMode: 'user' };

            navigator.mediaDevices.getUserMedia({ video: videoConstraints, audio: true })
            .then(function(stream) {
                localStream = stream;
                // stop previously attached srcObject tracks if any (defensive)
                try {
                    localVideo.srcObject = stream;
                    localVideo.muted = true;
                    localVideo.setAttribute('playsinline', '');
                    localVideo.play().catch(function(){ /* ignore autoplay rejection */ });
                } catch (e) {
                    console.warn('Could not set localVideo srcObject:', e);
                }
                // update camera dropdown labels now we have permission
                populateCameraList();
                if (cb) cb(stream);
            })
            .catch(function(err) {
                console.error('getUserMedia error:', err);
                alert('Camera/microphone access is required to make/answer calls.');
                if (cb) cb(null);
            });
        }

        // New: populate available video input devices into cameraSelect
        function populateCameraList() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return;
            navigator.mediaDevices.enumerateDevices()
            .then(function(devices) {
                var videoInputs = devices.filter(function(d) { return d.kind === 'videoinput'; });
                // preserve current selection
                var current = cameraSelect.value;
                cameraSelect.innerHTML = '<option value="">Default camera</option>';
                videoInputs.forEach(function(device) {
                    var option = document.createElement('option');
                    option.value = device.deviceId;
                    // use label when available (after permission), fallback to deviceId suffix
                    option.text = device.label || ('Camera ' + (cameraSelect.length));
                    cameraSelect.add(option);
                });
                // try to restore selection
                if (current) cameraSelect.value = current;
            })
            .catch(function(err) {
                console.warn('Could not list cameras:', err);
            });
        }

        // When user changes camera selection, re-acquire stream (user gesture recommended)
        cameraSelect.addEventListener('change', function() {
            // attempt to switch camera; this will stop old tracks and request new stream
            ensureLocalStream(function(stream){
                if (!stream) {
                    console.warn('Switch camera failed or permission denied');
                }
            });
        });

        document.getElementById('makeCall').addEventListener('click', function() {
            var selectedUserId = document.getElementById('userSelect').value;
            if (selectedUserId) {
                ensureLocalStream(function(stream) {
                    if (!stream) {
                        alert('Unable to get local media');
                        return;
                    }
                    var call = peer.call(selectedUserId, stream);
                    call.on('stream', function(remoteStream) {
                        try {
                            remoteVideo.srcObject = remoteStream;
                            remoteVideo.setAttribute('playsinline', '');
                            remoteVideo.play().catch(function(){ /* ignore */ });
                        } catch (e) {
                            console.warn('Could not play remote stream:', e);
                        }
                    });
                    call.on('error', function(err){ console.error('Call error', err); });
                });
            }
        });

        // Answer incoming calls only after ensuring we have local media
        var pendingCall = null;
        var answerBtn = document.getElementById('answerCall');

        // Replace auto-answer behavior: when a call arrives, save it and show the answer button
        peer.on('call', function(call) {
            console.log('Incoming call from', call.peer);
            pendingCall = call;
            answerBtn.style.display = 'inline-block';
            // optionally notify user in UI
            document.getElementById('chatLog').innerHTML += 'Incoming call from ' + call.peer + ' â€” click Answer Call to accept<br>';
        });

        // When user clicks Answer Call, request camera/mic (user gesture) and then answer
        answerBtn.addEventListener('click', function() {
            if (!pendingCall) return;
            // ensureLocalStream will prompt in a user gesture on iOS
            ensureLocalStream(function(stream) {
                if (!stream) {
                    alert('Could not get camera/microphone.');
                    return;
                }
                try {
                    pendingCall.answer(stream);
                } catch (e) {
                    console.error('Error answering call:', e);
                }
                pendingCall.on('stream', function(remoteStream) {
                    try {
                        remoteVideo.srcObject = remoteStream;
                        remoteVideo.setAttribute('playsinline', '');
                        remoteVideo.play().catch(function(){ /* ignore */ });
                    } catch (e) {
                        console.warn('Could not play remote stream:', e);
                    }
                });
                pendingCall.on('close', function() {
                    console.log('Call closed by peer');
                });
                pendingCall.on('error', function(err){ console.error('Call error', err); });

                // clear pending call and hide button
                pendingCall = null;
                answerBtn.style.display = 'none';
            });
        });

        // --- Changed: store inbound connections so we can reuse them ---
        peer.on('connection', function(c) {
            // store it
            users[c.peer] = users[c.peer] || { id: c.peer };
            users[c.peer].conn = c;

            c.on('data', function(data) {
                var chatLog = document.getElementById('chatLog');
                if (typeof data === 'string') {
                    if (data.indexOf('data:image/') === 0) {
                        var image = document.createElement('img');
                        image.src = data;
                        image.style.maxWidth = '400px';
                        image.style.display = 'block';
                        chatLog.appendChild(image);
                        chatLog.innerHTML += '<br>';
                    } else {
                        chatLog.innerHTML += 'Peer: ' + data + '<br>';
                    }
                } else if (data instanceof Blob || data instanceof ArrayBuffer) {
                    var url = URL.createObjectURL(data);
                    var image = document.createElement('img');
                    image.src = url;
                    image.style.maxWidth = '400px';
                    image.style.display = 'block';
                    chatLog.appendChild(image);
                    chatLog.innerHTML += '<br>';
                } else {
                    try {
                        chatLog.innerHTML += 'Peer: ' + JSON.stringify(data) + '<br>';
                    } catch (e) {
                        chatLog.innerHTML += 'Peer sent data<br>';
                    }
                }
            });

            c.on('open', function() {
                console.log('Inbound connection open from', c.peer);
            });

            c.on('close', function() {
                console.log('Inbound connection closed from', c.peer);
                if (users[c.peer]) delete users[c.peer].conn;
            });

            c.on('error', function(err){
                console.error('Inbound connection error from', c.peer, err);
            });
         });

        // Remove any unconditional navigator.mediaDevices.getUserMedia(...) auto-call at bottom
    </script>
    <div id="myPeerId"></div>
    <div id="chatLog"></div>
</body>
</html>
